<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sentinel Mobile</title>
    <style>
        :root {
            --bg: #1a1a1a;
            --panel: #2a2a2a;
            --ready: #28a745;
            --not-ready: #ffc107;
            --armed: #dc3545;
            --accent: #007bff;
        }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            background: var(--bg); color: white; margin: 0; 
            display: flex; justify-content: center; align-items: flex-start; 
            min-height: 100vh; padding: 20px; box-sizing: border-box;
        }

        .portal { 
            background: var(--panel); padding: 25px; border-radius: 16px; 
            text-align: center; width: 100%; max-width: 400px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); border: 1px solid #444; 
        }

        h1 { margin: 0 0 5px 0; letter-spacing: 2px; font-size: 28px; }

        .status-badge { 
            display: block; padding: 12px; border-radius: 12px; 
            font-size: 14px; font-weight: bold; margin: 15px 0; 
            transition: 0.3s; text-transform: uppercase;
        }
        
        .ready { background: var(--ready); color: white; }
        .not-ready { background: var(--not-ready); color: black; }
        .armed { background: var(--armed); color: white; }
        .offline { background: #444; color: #888; }

        .display { 
            background: #000; padding: 20px; font-size: 32px; 
            margin-bottom: 20px; border-radius: 8px; color: #0f0; 
            height: 40px; border: 1px solid #333; display: flex; 
            align-items: center; justify-content: center; letter-spacing: 8px;
        }

        /* Large Touch Keypad */
        .keypad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }
        .key { 
            background: #333; padding: 25px 0; border-radius: 12px; 
            font-size: 24px; cursor: pointer; border: 1px solid #444; 
            -webkit-tap-highlight-color: transparent; touch-action: manipulation;
        }
        .key:active { background: var(--accent); }

        #maint-menu { display: none; padding-top: 10px; }
        
        /* Full-width mobile buttons */
        .menu-btn { 
            display: block; padding: 20px; margin: 12px 0; 
            border-radius: 12px; font-weight: bold; width: 100%; 
            border: none; cursor: pointer; font-size: 18px; 
            color: white; text-decoration: none; box-sizing: border-box;
        }
        .btn-arm { background: var(--accent); }
        .btn-arm:disabled { background: #333; color: #666; cursor: not-allowed; opacity: 0.6; }
        .btn-disarm { background: var(--ready); }
        .btn-nav { background: #444; font-size: 16px; }

        hr { border: 0; border-top: 1px solid #444; margin: 20px 0; }

        /* Media Query for very small screens */
        @media (max-width: 360px) {
            .key { padding: 18px 0; font-size: 20px; }
            .display { font-size: 24px; }
        }
    </style>
</head>
<body>
    <div class="portal">
        <h1>SENTINEL</h1>
        <div id="quick-status" class="status-badge offline">CONNECTING...</div>

        <div id="auth-section">
            <div class="display" id="pin-display"></div>
            <div class="keypad">
                <div class="key" onclick="press(1)">1</div><div class="key" onclick="press(2)">2</div><div class="key" onclick="press(3)">3</div>
                <div class="key" onclick="press(4)">4</div><div class="key" onclick="press(5)">5</div><div class="key" onclick="press(6)">6</div>
                <div class="key" onclick="press(7)">7</div><div class="key" onclick="press(8)">8</div><div class="key" onclick="press(9)">9</div>
                <div class="key" style="color:var(--armed)" onclick="clr()">C</div><div class="key" onclick="press(0)">0</div><div class="key" style="color:var(--ready)" onclick="submit()">OK</div>
            </div>
        </div>

        <div id="maint-menu">
            <div id="user-info" style="font-size: 14px; color: #aaa; margin-bottom: 15px;"></div>
            
            <div id="arm-group">
                <button id="arm-away-btn" class="menu-btn btn-arm" onclick="doAction('/api/arm', {mode:'away'})">ARM AWAY</button>
                <button id="arm-stay-btn" class="menu-btn btn-arm" onclick="doAction('/api/arm', {mode:'stay'})">ARM STAY</button>
            </div>
            
            <button id="btn-disarm" class="menu-btn btn-disarm" style="display:none;" onclick="doAction('/api/disarm', {})">DISARM SYSTEM</button>

            <hr>
            <div id="admin-links" style="display:none;">
                <a href="status.html" class="menu-btn btn-nav">ðŸ“Š Zone Status</a>
                <a href="users.html" class="menu-btn btn-nav">ðŸ‘¤ User Management</a>
            </div>
            <button onclick="location.reload()" style="background:none; border:none; color:#777; cursor:pointer; font-size:14px; padding:10px;">Logout / Lock</button>
        </div>
    </div>

    <script>
        let pin = "";
        
        // Touch-friendly press
        function press(n) { 
            if(pin.length < 4) { 
                pin += n; 
                document.getElementById('pin-display').innerText = "â€¢".repeat(pin.length); 
            } 
        }

        function clr() { pin = ""; document.getElementById('pin-display').innerText = ""; }

        async function submit() {
            const res = await fetch('/api/auth', { 
                method: 'POST', 
                body: JSON.stringify({pin}),
                headers: {'Content-Type': 'application/json'} 
            });
            const data = await res.json();
            if(data.authenticated) {
                document.getElementById('auth-section').style.display = "none";
                document.getElementById('maint-menu').style.display = "block";
                document.getElementById('user-info').innerText = "User: " + data.name;
                if(data.is_admin) document.getElementById('admin-links').style.display = "block";
                updateUI(data.state, true); 
            } else {
                clr();
                document.getElementById('pin-display').innerText = "ERROR";
                setTimeout(clr, 1000);
            }
        }

        function updateUI(state, isReady) {
            const badge = document.getElementById('quick-status');
            const armed = (state !== 0);
            
            if(armed) {
                badge.innerText = "SYSTEM ARMED";
                badge.className = "status-badge armed";
            } else {
                badge.innerText = isReady ? "READY TO ARM" : "NOT READY (CHECK ZONES)";
                badge.className = "status-badge " + (isReady ? "ready" : "not-ready");
            }

            if(document.getElementById('maint-menu').style.display === "block") {
                document.getElementById('arm-group').style.display = armed ? "none" : "block";
                document.getElementById('btn-disarm').style.display = armed ? "block" : "none";
                document.getElementById('arm-away-btn').disabled = !isReady;
                document.getElementById('arm-stay-btn').disabled = !isReady;
            }
        }

        async function doAction(url, body) {
            const res = await fetch(url, { 
                method: 'POST', 
                body: JSON.stringify(body),
                headers: {'Content-Type': 'application/json'}
            });
            if(!res.ok) {
                const data = await res.json();
                alert(data.msg || "Action Failed");
            }
            check();
        }

        async function check() {
            try {
                const res = await fetch('/api/status?t=' + Date.now());
                const data = await res.json();
                updateUI(data.state, data.is_ready);
            } catch(e) { 
                document.getElementById('quick-status').innerText = "OFFLINE"; 
                document.getElementById('quick-status').className = "status-badge offline";
            }
        }

        setInterval(check, 3000);
        check();
    </script>
</body>
</html>
