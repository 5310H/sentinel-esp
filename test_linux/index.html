<!DOCTYPE html>
<html>
<head>
    <title>Sentinel Core</title>
    <style>
        body { font-family: sans-serif; background: #1a1a1a; color: #eee; text-align: center; }
        .box { border: 2px solid #444; padding: 20px; margin: 10px auto; width: 400px; border-radius: 10px; background: #222; }
        .keypad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        button { padding: 12px; font-size: 16px; cursor: pointer; background: #333; color: white; border: 1px solid #555; border-radius: 5px; }
        button:hover { background: #444; }
        .hidden { display: none; }
        .admin-btn { background: #d35400; margin-top: 10px; width: 100%; }
        table { width: 100%; margin-top: 10px; border-collapse: collapse; font-size: 14px; }
        th, td { border: 1px solid #444; padding: 6px; }
        input { padding: 8px; margin: 5px; width: 80%; background: #333; color: white; border: 1px solid #555; }
        .section { text-align: left; border-top: 1px solid #444; padding-top: 10px; margin-top: 10px; }
    </style>
</head>
<body>
    <h1>SENTINEL CORE</h1>

    <div id="login-screen" class="box">
        <h3>ENTER PIN</h3>
        <div id="pin-display" style="font-size: 24px; margin-bottom: 10px; color: #27ae60;">____</div>
        <div class="keypad" id="keys"></div>
        <button onclick="submitPin()" style="width:100%; margin-top:10px; background:#27ae60;">OK</button>
    </div>

    <div id="dash-screen" class="box hidden">
        <h2 id="welcome"></h2>
        <button style="background:#c0392b; width:45%;">ARM</button>
        <button style="background:#27ae60; width:45%;">DISARM</button>
        <button id="maint-btn" class="admin-btn hidden" onclick="showMaint()">MAINTENANCE</button>
        <button onclick="location.reload()" style="width:100%; margin-top:10px;">LOGOUT</button>
    </div>

    <div id="maint-screen" class="box hidden" style="width: 600px;">
        <h2>MAINTENANCE MODE</h2>
        
        <div class="section">
            <h4>System Info</h4>
            <div id="config-data">Loading...</div>
        </div>

        <div class="section">
            <h4>User Management</h4>
            <table id="user-table"></table>
            <hr>
            <h4>Add New User</h4>
            <input id="new-name" placeholder="Name">
            <input id="new-pin" placeholder="PIN">
            <label><input type="checkbox" id="new-admin"> Is Admin</label><br>
            <button onclick="createUser()" style="background:#27ae60;">Save New User</button>
        </div>
        
        <button onclick="document.getElementById('maint-screen').className='box hidden'" style="margin-top:20px; width:100%;">CLOSE MAINTENANCE</button>
    </div>

    <script>
        let currentPin = "";
        let adminId = null;

        const keys = document.getElementById('keys');
        [1,2,3,4,5,6,7,8,9,'C',0,'<'].forEach(k => {
            let b = document.createElement('button');
            b.innerText = k;
            b.onclick = () => {
                if(k === 'C') currentPin = "";
                else if(k === '<') currentPin = currentPin.slice(0,-1);
                else currentPin += k;
                document.getElementById('pin-display').innerText = "*".repeat(currentPin.length) || "____";
            };
            keys.appendChild(b);
        });

        async function submitPin() {
            const res = await fetch('/api/login', { method: 'POST', body: `pin=${currentPin}` });
            const data = await res.json();
            if(data.id) {
                adminId = data.id;
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('dash-screen').classList.remove('hidden');
                document.getElementById('welcome').innerText = "System: " + data.name;
                if(data.isAdmin) document.getElementById('maint-btn').classList.remove('hidden');
            } else { alert("Denied"); currentPin = ""; }
        }

        async function showMaint() {
            // Get Config
            const cRes = await fetch('/api/config');
            const conf = await cRes.json();
            document.getElementById('config-data').innerHTML = `
                <b>Owner:</b> ${conf.owner} (ID: ${conf.acct})<br>
                <b>Zones:</b> ${conf.zones.map(z => z.name).join(', ')}<br>
                <b>Relays:</b> ${conf.relays.map(r => r.name).join(', ')}
            `;

            // Get Users
            const uRes = await fetch('/api/users', { headers: {'X-Admin-ID': adminId} });
            const users = await uRes.json();
            let html = "<tr><th>Name</th><th>Admin</th><th>Action</th></tr>";
            users.forEach(u => {
                html += `<tr><td>${u.name}</td><td>${u.isAdmin}</td>
                         <td><button onclick="deleteUser(${u.id})">DEL</button></td></tr>`;
            });
            document.getElementById('user-table').innerHTML = html;
            document.getElementById('maint-screen').classList.remove('hidden');
        }

        async function createUser() {
            const name = document.getElementById('new-name').value;
            const pin = document.getElementById('new-pin').value;
            const adm = document.getElementById('new-admin').checked;
            await fetch('/api/users', {
                method: 'POST',
                headers: {'X-Admin-ID': adminId},
                body: `name=${name}&pin=${pin}&isAdmin=${adm}`
            });
            showMaint();
        }

        async function deleteUser(id) {
            if(!confirm("Delete user " + id + "?")) return;
            await fetch('/api/users', {
                method: 'DELETE',
                headers: {'X-Admin-ID': adminId},
                body: `id=${id}`
            });
            showMaint();
        }
    </script>
</body>
</html>
