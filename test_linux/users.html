<!DOCTYPE html>
<html>
<head>
    <title>Sentinel - User Maint</title>
    <style>
        body { font-family: sans-serif; background: #1a1a1a; color: white; padding: 20px; }
        .nav { margin-bottom: 20px; border-bottom: 1px solid #444; padding-bottom: 10px; }
        .nav a { color: #007bff; text-decoration: none; margin-right: 20px; font-weight: bold; }
        .box { background: #2a2a2a; padding: 20px; border-radius: 8px; max-width: 800px; margin: auto; }
        input, select { background: #333; color: white; border: 1px solid #444; padding: 10px; width: 100%; margin: 5px 0; box-sizing: border-box; }
        table { width: 100%; margin-top: 20px; border-collapse: collapse; }
        th, td { padding: 10px; border-bottom: 1px solid #444; text-align: left; }
        .btn { padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .btn-primary { background: #007bff; color: white; width: 100%; }
        .btn-edit { background: #ffc107; color: black; }
        .btn-del { background: #dc3545; color: white; }
        .btn-test { background: #17a2b8; color: white; font-size: 11px; padding: 5px; }
    </style>
</head>
<body>
    <div class="box">
        <div class="nav">
            <a href="status.html">‚Üê Alarm Status</a>
            <span>User Management</span>
        </div>

        <h3>Add / Edit User</h3>
        <input type="text" id="name" placeholder="User Name">
        <input type="password" id="pin" placeholder="Security PIN">
        <input type="email" id="email" placeholder="Email Address">
        <select id="notify">
            <option value="1">1 - Silent (Local Only)</option>
            <option value="2">2 - Email Alerts</option>
            <option value="3">3 - Telegram Bot</option>
            <option value="4">4 - Noonlight Pro Dispatch</option>
        </select>
        <button id="submit-btn" class="btn btn-primary" onclick="handleSave()">Add User</button>

        <table>
            <thead><tr><th>Name</th><th>Email</th><th>Notify</th><th>Actions</th></tr></thead>
            <tbody id="user-table-body"></tbody>
        </table>
    </div>

    <script>
        async function loadUsers() {
            const res = await fetch('/api/users?t=' + Date.now());
            const users = await res.json();
            document.getElementById('user-table-body').innerHTML = users.map(u => `
                <tr>
                    <td>${u.name}</td>
                    <td>${u.email}</td>
                    <td><b>Type ${u.notify}</b></td>
                    <td>
                        <button class="btn btn-edit" onclick="setEdit('${u.name}','${u.email}',${u.notify})">Edit</button>
                        <button class="btn btn-test" onclick="testNotify('${u.name}')">Test</button>
                        <button class="btn btn-del" onclick="deleteUser('${u.name}')">Del</button>
                    </td>
                </tr>`).join('');
        }

        function setEdit(name, email, notify) {
            document.getElementById('name').value = name;
            document.getElementById('name').disabled = true;
            document.getElementById('email').value = email;
            document.getElementById('notify').value = notify;
            document.getElementById('submit-btn').innerText = "Update User";
        }

        async function handleSave() {
            const isUpdate = document.getElementById('submit-btn').innerText.includes("Update");
            const payload = {
                name: document.getElementById('name').value,
                pin: document.getElementById('pin').value,
                email: document.getElementById('email').value,
                notify: parseInt(document.getElementById('notify').value)
            };
            await fetch(isUpdate ? '/api/users/update' : '/api/users/add', {
                method: 'POST',
                body: JSON.stringify(payload)
            });
            location.reload();
        }

        async function deleteUser(name) {
            if(confirm("Delete " + name + "?")) {
                await fetch('/api/users/delete', { method: 'POST', body: JSON.stringify({name}) });
                loadUsers();
            }
        }

        async function testNotify(name) {
            alert("Sending test notification to " + name + "...");
            await fetch('/api/test_notify?name=' + name);
        }

        loadUsers();
    </script>
</body>
</html>
